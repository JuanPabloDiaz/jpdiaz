---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import { ui, defaultLang } from '../../i18n/ui';
import Navbar from '../../components/Navbar.astro';

const blogMenu = [
	{ title: 'Home', path: '/' },
	{ title: 'Blog', path: '/blog' },
];

const lang = defaultLang;
const posts = (await getCollection('blog'))
  .filter(post => post.data.lang === lang)
  .filter(post => {
    // In dev mode, show all posts
    if (import.meta.env.DEV) return true;
    // In production, only show non-draft posts
    return !post.data.draft;
  })
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const currentPath = Astro.url.pathname;
const langToggleUrl = currentPath.startsWith('/es/') ? currentPath.replace('/es/', '/') : `/es${currentPath}`;
---

<Layout metaTitle="Blog | Juan Diaz" includeSidebar={false}>
  <Navbar menu={blogMenu} button="Resume" />
  <div class="fixed right-4 top-20 z-50">
    <a
      href={langToggleUrl}
      class="rounded-lg bg-gray-100 px-3 py-1 text-sm text-gray-700 hover:bg-gray-200 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700"
    >
      {lang === 'es' as const ? 'English' : 'Espa√±ol'}
    </a>
  </div>
  <section class="mx-auto max-w-3xl px-4 py-8 text-black dark:text-white">
    <h1 class="mb-8 text-4xl font-bold text-black dark:text-white">
      {ui[lang]['blog.title']}
    </h1>
    <div class="space-y-8">
      {posts.map((post) => (
        <article class="group relative rounded-lg border border-zinc-200 p-6 dark:border-zinc-800">
          <h2 class="mb-2 text-2xl font-semibold text-black dark:text-white">
            <a href={`/blog/${post.slug}`} class="hover:text-blue-600 dark:hover:text-blue-400">
              {post.data.title}
            </a>
          </h2>
          <p class="mb-4 text-gray-600 dark:text-gray-300">{post.data.description}</p>
          <div class="flex flex-wrap items-center gap-4 text-sm">
            <time datetime={post.data.pubDate.toISOString()} class="text-gray-600 dark:text-gray-300">
              {ui[lang]['blog.publishedOn']} {post.data.pubDate.toLocaleDateString('en-US')}
            </time>
            <div class="flex flex-wrap gap-2">
              {post.data.tags.map((tag) => (
                <span class="rounded-full bg-gray-100 px-3 py-1 text-sm text-gray-700 dark:bg-gray-800 dark:text-gray-300">
                  #{tag}
                </span>
              ))}
            </div>
          </div>
          <a
            href={`/blog/${post.slug}`}
            class="absolute inset-0 rounded-lg ring-blue-600 ring-offset-2 ring-offset-white hover:ring-2 dark:ring-offset-zinc-900"
            aria-label={`Read ${post.data.title}`}
          />
        </article>
      ))}
    </div>
  </section>
</Layout>
